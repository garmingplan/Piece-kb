name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # 当推送版本标签时触发（如 v0.1.0）
  workflow_dispatch:  # 允许手动触发

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout 代码
        uses: actions/checkout@v4

      - name: 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 运行打包脚本
        run: |
          python build.py

      - name: 获取版本号
        id: get_version
        shell: bash
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="0.1.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: 查找 ZIP 文件
        id: find_zip
        shell: bash
        run: |
          ZIP_FILE=$(ls dist/Piece_v*.zip | head -n 1)
          echo "zip_file=$ZIP_FILE" >> $GITHUB_OUTPUT
          echo "Found: $ZIP_FILE"

      - name: 创建 Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.find_zip.outputs.zip_file }}
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## Piece v${{ steps.get_version.outputs.version }}

            ### 安装说明
            1. 下载 `Piece_v${{ steps.get_version.outputs.version }}_*.zip` 文件
            2. 解压到任意目录
            3. 双击 `Piece.exe` 启动应用

            ### MCP 服务配置
            - 默认端口: 8686
            - 端点: http://localhost:8686/mcp

            ### 更新内容
            详见下方自动生成的 Release Notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: Piece-Windows-${{ steps.get_version.outputs.version }}
          path: ${{ steps.find_zip.outputs.zip_file }}
          retention-days: 30
